<template>
  <div class="bg-grey-2 q-pa-md font-arial" style="min-height: 100vh">
    <div class="text-center q-mb-xl q-mt-md">
      <div class="row justify-center q-mb-sm">
        <q-avatar size="70px" color="indigo-6" text-color="white" class="shadow-3">
          <q-icon name="waving_hand" size="40px" />
        </q-avatar>
      </div>

      <div class="text-h5 text-weight-bold text-grey-9">
        ¡Bienvenido a TCS, {{ nombreUsuario }}!
      </div>

      <div class="text-subtitle1 text-grey-7">Estamos emocionados de tenerte en nuestro equipo</div>
    </div>

    <div class="row q-col-gutter-lg justify-center" style="max-width: 1200px; margin: 0 auto">
      <div class="col-12 col-md-7">
        <div class="row items-center justify-between q-mb-sm">
          <div class="text-h6 text-weight-bold text-grey-9">Mi Progreso</div>
          <q-avatar
            color="indigo-6"
            text-color="white"
            size="45px"
            font-size="14px"
            class="text-weight-bold shadow-1"
          >
            {{ porcentajeProgreso }}%
          </q-avatar>
        </div>

        <q-card class="shadow-1" style="border-radius: 12px">
          <q-card-section>
            <div class="q-mb-md">
              <q-linear-progress
                :value="porcentajeProgreso / 100"
                size="12px"
                color="indigo-6"
                track-color="grey-3"
                rounded
                class="q-mb-xs"
              />
              <div class="text-grey-7 text-caption text-weight-medium">
                {{ completadas.length }} de {{ totalActividades }} tareas completadas
              </div>
            </div>

            <q-list separator>
              <!-- Mostrar sólo completadas en el panel 'Mi Progreso' -->
              <q-item v-for="task in completadas" :key="task._id || task.id" class="q-py-md">
                <q-item-section avatar style="min-width: 40px">
                  <q-icon name="check_circle" color="indigo-6" size="26px" />
                </q-item-section>

                <q-item-section>
                  <q-item-label class="text-indigo-8 text-weight-medium">
                    {{ task.titulo || task.nombre || 'Sin título' }}
                  </q-item-label>
                </q-item-section>

                <q-item-section side>
                  <q-icon name="chevron_right" color="grey-5" />
                </q-item-section>
              </q-item>
            </q-list>
          </q-card-section>
        </q-card>
      </div>

      <div class="col-12 col-md-5">
        <div class="text-h6 text-weight-bold text-grey-9 q-mb-sm">Mis Próximos Pasos</div>

        <q-card class="shadow-1" style="border-radius: 12px">
          <q-card-section>
            <!-- Si no hay pendientes -->
            <div v-if="pendientes.length === 0" class="text-center text-grey-6 q-pa-lg">
              <q-icon name="check_circle" size="48px" class="q-mb-md opacity-50" />
              <div class="text-subtitle1">¡Sin actividades pendientes!</div>
              <div class="text-caption">¡Excelente trabajo!</div>
            </div>

            <!-- Listado de pendientes -->
            <q-list v-else separator>
              <q-item v-for="task in pendientes" :key="task._id || task.id" class="q-py-md">
                <q-item-section avatar style="min-width: 40px">
                  <q-icon name="schedule" color="orange" size="26px" />
                </q-item-section>

                <q-item-section>
                  <q-item-label class="text-grey-9">
                    {{ task.titulo || task.nombre || 'Sin título' }}
                  </q-item-label>
                  <q-item-label caption>
                    {{ task.descripcion || 'Sin descripción' }}
                  </q-item-label>
                </q-item-section>

                <q-item-section side>
                  <q-icon name="chevron_right" color="grey-5" />
                </q-item-section>
              </q-item>
            </q-list>
          </q-card-section>
        </q-card>
      </div>
    </div>

    <div class="row q-col-gutter-lg justify-center q-mt-lg" style="max-width: 1200px; margin: 0 auto">
      <div class="col-12 col-md-7"></div>
      <div class="col-12 col-md-5">
        <div class="text-h6 text-weight-bold text-grey-9 q-mb-sm">Tu Supervisor</div>

        <q-card class="shadow-1 text-center q-pa-lg bg-white" style="border-radius: 12px">
          <div class="column items-center">
            <q-avatar
              size="90px"
              color="indigo-5"
              text-color="white"
              class="text-h4 shadow-2 q-mb-md"
            >
              {{
                supervisorInfo.nombre
                  .split(' ')
                  .map((n) => n[0])
                  .join('')
                  .toUpperCase()
              }}
            </q-avatar>

            <div class="text-h6 text-weight-bold text-grey-9">{{ supervisorInfo.nombre }}</div>
            <div class="text-subtitle2 text-grey-6 q-mb-lg">{{ supervisorInfo.cargo }}</div>

            <q-card flat bordered class="full-width bg-grey-1 q-pa-sm">
              <q-list dense>
                <q-item class="q-px-none justify-center">
                  <q-icon name="email" color="indigo-5" class="q-mr-sm" size="20px" />
                  <span class="text-grey-8">{{ supervisorInfo.email }}</span>
                </q-item>
                <q-item class="q-px-none justify-center">
                  <q-icon name="phone" color="indigo-5" class="q-mr-sm" size="20px" />
                  <span class="text-grey-8">{{ supervisorInfo.telefono }}</span>
                </q-item>
              </q-list>
            </q-card>
          </div>
        </q-card>
      </div>
    </div>

    <footer class="text-center text-grey-5 q-py-lg text-caption">
      Si necesitas ayuda inmediata, contacta a tu supervisor o al equipo de Recursos Humanos
    </footer>
  </div>
</template>

<script>
import { ref, onMounted, computed, onUnmounted } from 'vue'
import { useNotificationsStore } from 'src/stores/notifications'
import { api } from 'src/boot/axios'
import { Notify, useQuasar } from 'quasar'
import { useRouter } from 'vue-router'
import { isValidObjectId } from 'src/composables/useUsuario'
import { useActividades } from 'src/composables/useActividades'

export default {
  name: 'DashboardPage',
  setup() {
    const $q = useQuasar()
    const notificationsStore = useNotificationsStore()
    const router = useRouter()

    // Usar composable de actividades
    const {
      completadas,
      pendientes,
      totalActividades,
      porcentajeProgreso,
      obtenerActividadesUsuario,
      obtenerPendientes,
    } = useActividades()

    const nombreUsuario = ref('Colaborador')
    const supervisorInfo = ref({
      nombre: 'Carlos García Pérez',
      cargo: 'Reclutador de Recursos Humanos',
      email: 'carlos.garcia@tcs.com',
      telefono: '+51 912 345 678',
    })

    const loadUserData = async () => {
      try {
        const userStorage = localStorage.getItem('user')
        const token = localStorage.getItem('token')
        const usuarioRef = localStorage.getItem('usuarioRef')

        if (userStorage) {
          const user = JSON.parse(userStorage)
          if (user.nombre) {
            nombreUsuario.value = user.nombre
          }
        }

        // Cargar supervisor si existe (mantener dependencia de token para este recurso)
        if (token) {
          try {
            // Obtener rolRef del usuario autenticado
            const userStorage = localStorage.getItem('user')
            const user = userStorage ? JSON.parse(userStorage) : null
            const rolRef = user && (user.rol_ref || user.rolRef || user.role?._id || user.role?.id)

            if (rolRef) {
              if (!isValidObjectId(String(rolRef))) {
                Notify.create({
                  type: 'negative',
                  message: 'Rol inválido. Inicie sesión nuevamente.',
                })
                router.push('/login')
              } else {
                // Obtener usuarios con el rol del usuario actual
                const supervisorRes = await api.get(`Usuario/rol/${rolRef}`)
                // Tomar el primer usuario del array como supervisor
                const supervisorData = Array.isArray(supervisorRes.data)
                  ? supervisorRes.data[0]
                  : supervisorRes.data?.data?.[0]
                if (supervisorData) {
                  supervisorInfo.value = {
                    nombre: supervisorData.nombre || supervisorInfo.value.nombre,
                    cargo: supervisorData.cargo || supervisorInfo.value.cargo,
                    email: supervisorData.correo || supervisorInfo.value.email,
                    telefono: supervisorData.telefono || supervisorInfo.value.telefono,
                  }
                }
              }
            }
          } catch (err) {
            console.warn('No se pudo cargar el supervisor:', err)
          }
        }

        // Cargar actividades del usuario usando el composable
        if (usuarioRef) {
          await obtenerActividadesUsuario(usuarioRef)
          await obtenerPendientes(usuarioRef)
        }
      } catch (error) {
        console.error('Error loading user data:', error)
      }
    }

    onMounted(() => {
      loadUserData()
      // Cargar notificaciones
      notificationsStore.fetchNotifications()
    })

    return {
      nombreUsuario,
      supervisorInfo,
      completadas,
      pendientes,
      totalActividades,
      porcentajeProgreso,
    }
  },
}
</script>
</script>

<style scoped>
.font-arial {
  font-family: 'Arial', sans-serif;
}
</style>
